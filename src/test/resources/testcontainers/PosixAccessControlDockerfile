# We use a builder image which fully prepares the /opt/crane directory.
# This directory can then be copied in *one step* to the final image.
# In addition we also need unzip during build but not during runtime.
FROM public.ecr.aws/docker/library/debian:buster as builder

# can be snapshots or releases
ARG NEXUS_REPOSITORY=releases
ARG JAR_LOCATION=https://nexus.openanalytics.eu/service/rest/v1/search/assets/download?sort=version&repository=$NEXUS_REPOSITORY&maven.groupId=eu.openanalytics.rdepot&maven.artifactId=crane&maven.extension=jar

RUN mkdir /opt/crane
ADD $JAR_LOCATION /opt/crane/crane.jar

RUN apt-get update -y && \
  apt-get install unzip && \
  unzip -p  /opt/crane/crane.jar META-INF/MANIFEST.MF | sed -En 's/Implementation-Version: (.*)\r/\1/gp' > /opt/crane/VERSION

# FINAL IMAGE
FROM public.ecr.aws/docker/library/eclipse-temurin:17-jammy

LABEL maintainer="Tobia De Koninck <tdekoninck@openanalytics.eu>"

COPY $CONFIGURATION /opt/crane/

# CREATE USERS AND GROUPS
RUN useradd demo && \
    useradd test && \
    groupadd scientists && \
    groupadd mathematicians && \
    groupadd crane_public

COPY --from=builder /opt/crane /opt/crane

# CREATE REPOSITORIES AND THEIR FILES
RUN mkdir /tmp/posix_repository && \
    mkdir /tmp/posix_repository/public_repo && \
    touch /tmp/posix_repository/public_repo/index.html && \
    mkdir /tmp/posix_repository/public_repo/public_repo && \
    touch /tmp/posix_repository/public_repo/public_repo/index.html && \
    mkdir /tmp/posix_repository/public_repo/only_owner_demo && \
    touch /tmp/posix_repository/public_repo/only_owner_demo/index.html && \
    mkdir /tmp/posix_repository/public_repo/only_group_scientists && \
    touch /tmp/posix_repository/public_repo/only_group_scientists/index.html && \
    mkdir /tmp/posix_repository/public_repo/only_group_mathematicians && \
    touch /tmp/posix_repository/public_repo/only_group_mathematicians/index.html && \
    mkdir /tmp/posix_repository/public_repo/no_posix_access && \
    touch /tmp/posix_repository/public_repo/no_posix_access/index.html && \
    mkdir /tmp/posix_repository/public_repo/no_path_access && \
    touch /tmp/posix_repository/public_repo/no_path_access/index.html && \
    mkdir /tmp/posix_repository/only_owner_demo && \
    touch /tmp/posix_repository/only_owner_demo/index.html && \
    mkdir /tmp/posix_repository/only_group_scientists && \
    touch /tmp/posix_repository/only_group_scientists/index.html && \
    mkdir /tmp/posix_repository/only_group_mathematicians && \
    touch /tmp/posix_repository/only_group_mathematicians/index.html && \
    mkdir /tmp/posix_repository/no_path_access && \
    touch /tmp/posix_repository/no_path_access/index.html && \
    mkdir /tmp/posix_repository/no_posix_access && \
    touch /tmp/posix_repository/no_posix_access/index.html

# SET POSIX PERMISSIONS
RUN chgrp -R crane_public /tmp/posix_repository && \
    chmod -R u+r,g+r /tmp/posix_repository && \
    chown -R demo /tmp/posix_repository/public_repo/only_owner_demo /tmp/posix_repository/only_owner_demo && \
    chmod -R u+r /tmp/posix_repository/public_repo/only_owner_demo /tmp/posix_repository/only_owner_demo && \
    chmod -R u-r,g-r /tmp/posix_repository/public_repo/no_posix_access /tmp/posix_repository/no_posix_access && \
    chgrp -R scientists /tmp/posix_repository/public_repo/only_group_scientists /tmp/posix_repository/only_group_scientists && \
    chgrp -R mathematicians  /tmp/posix_repository/public_repo/only_group_mathematicians /tmp/posix_repository/only_group_mathematicians && \
    chmod -R u-r,g+r /tmp/posix_repository/public_repo/only_group_scientists /tmp/posix_repository/only_group_scientists

WORKDIR /opt/crane

CMD ["java", "-noverify", "-jar", "/opt/crane/crane.jar", "--spring.jmx.enabled=false", "--spring.config.location=/opt/crane/application.yml"]
